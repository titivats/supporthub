<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>History - Done & Cancelled Tickets</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --line:#e7e7ee; --muted:#6B7280; --thead:#f0f2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Arial}
    .container{max-width:1400px;margin:26px auto;padding:0 16px}
    .title{font-size:24px;font-weight:700;margin-bottom:8px}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 14px}

    .btn, a.btn, button.btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border:1px solid var(--line);border-radius:10px;
      background:#fff;text-decoration:none;color:#111;cursor:pointer;
      font-size:14px;line-height:1.2;
    }
    .btn.primary{background:#2563eb;color:#fff;border-color:#1f5fe6}
    select,input{padding:8px;border:1px solid #d7d9e0;border-radius:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .table-wrap{overflow:auto;max-height:calc(100vh - 220px);border-top:1px solid var(--line);}
    table{border-collapse:collapse; width:max-content; min-width:1600px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;white-space:nowrap}
    th{background:var(--thead); position:sticky; top:0; z-index:1}

    .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .cancel{background:#fef2f2;border-color:#fecaca;color:#991B1B}
    .done{background:#ecfeff;border-color:#bae6fd;color:#075985}

    .wrap-text{max-width:260px;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;}

    tbody tr{cursor:pointer; transition: background-color .15s ease;}
    tbody tr:hover{background:#f3f6ff;}
    tbody tr.row-selected{background:#e0f2fe !important; box-shadow: inset 0 0 0 2px #bae6fd;}
    .id-btn{all:unset; cursor:pointer; color:#2563eb; font-weight:600;}
    .id-btn:hover{text-decoration:underline;}
  </style>
</head>
<body>
<div class="container">
  <div class="title">Done & Cancelled Tickets</div>

  <form id="filterForm" class="filters" method="get" action="/history">
    <label>Line No.
      <select name="line_op" id="filterLine">
        <option value="">All</option>
        {% for lo in line_ops %}
          <option value="{{ lo }}" {% if line_op==lo %}selected{% endif %}>{{ lo }}</option>
        {% endfor %}
      </select>
    </label>

    <label>Machine
      <select name="machine_type" id="filterType">
        <option value="">All</option>
        {% for mt in machine_type_map.keys()|list|sort %}
          <option value="{{ mt }}" {% if machine_type==mt %}selected{% endif %}>{{ mt }}</option>
        {% endfor %}
        {% if machine_type and machine_type not in machine_type_map %}
          <option value="{{ machine_type }}" selected>{{ machine_type }}</option>
        {% endif %}
      </select>
    </label>

    <label>Machine Type
      <select name="machine_brand" id="filterBrand" data-selected="{{ machine_brand }}">
        <option value="">All</option>
      </select>
    </label>

    <label>Date
      <input type="date" name="start_date" id="filterStart" value="{{ start_date or '' }}">
    </label>
    <span>to</span>
    <label>
      <input type="date" name="end_date" id="filterEnd" value="{{ end_date or '' }}">
    </label>

    <button class="btn primary" type="submit">Filter</button>
    <button class="btn" type="button" id="btnClear">Clear</button>
    <button class="btn" type="button" onclick="goBack()">Back</button>

    <button class="btn" type="button" id="exportBtn">Export Excel</button>
  </form>

  {% macro hms(sec) -%}
    {%- set s = (sec or 0)|int -%}
    {%- set h = s // 3600 -%}
    {%- set m = (s % 3600) // 60 -%}
    {%- set ss = s % 60 -%}
    {{ '%02d:%02d:%02d'|format(h,m,ss) }}
  {%- endmacro %}

  <div class="card">
    <div class="table-wrap">
      <table id="historyTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Status</th>
            <th>Created (TH)</th>
            <th>Closed (TH)</th>
            <th>Request by</th>
            <th>Line No.</th>
            <th>Machine</th>
            <th>Machine Type</th>
            <th>Machine ID</th>
            <th>Problem</th>
            <th class="wrap-text">Description</th>
            <th>Doing</th>
            <th>Hold</th>
            <th>Hold Reason</th>
            <th>Waiting Time</th>
            <th>Downtime</th>
            <th>Solution</th>
            <th>Cancel Reason</th>
            <th>Done By</th>
          </tr>
        </thead>
        <tbody id="tbody">
          {% for r in rows %}
          {% set type = (r.history_machine or '') %}
          {% set brand = (r.history_machine_type or '') %}
          {% set sum_secs = ((r.closed_at - r.created_at).total_seconds() if r.closed_at and r.created_at else 0) | int %}
          {% set doing    = (r.doing_secs or 0) | int %}
          {% set hold     = (r.hold_secs  or 0) | int %}
          {% set wait_secs = (sum_secs - doing - hold) if (sum_secs - doing - hold) > 0 else 0 %}
          <tr id="row-{{ r.id }}">
            <td><button class="id-btn" type="button" data-id="{{ r.id }}">{{ r.id }}</button></td>
            <td>
              {% if r.status == 'CANCELLED' %}
                <span class="badge cancel">CANCELLED</span>
              {% else %}
                <span class="badge done">DONE</span>
              {% endif %}
            </td>
            <td>{{ fmt_th(r.created_at) }}</td>
            <td>{{ fmt_th(r.closed_at) }}</td>
            <td>{{ r.requester }}</td>
            <td>{{ r.machine }}</td>
            <td>{{ (type or '') }}</td>
            <td>{{ brand or '-' }}</td>
            <td>{{ r.machine_id or '-' }}</td>
            <td>{{ r.problem or '' }}</td>
            <td class="wrap-text">{{ r.description or '-' }}</td>
            <td>{{ hms(doing) }}</td>
            <td>{{ hms(hold) }}</td>
            <td class="wrap-text">{{ r.hold_reason or '-' }}</td>
            <td>{{ hms(wait_secs) }}</td>
            <td>{{ hms(sum_secs) }}</td>
            <td class="wrap-text">{{ r.solution or '-' }}</td>
            <td class="wrap-text">{{ r.cancel_reason or '-' }}</td>
            <td>
              {% if r.status == 'DONE' %}{{ r.done_by or '' }}
              {% elif r.status == 'CANCELLED' %}{{ r.canceled_by or '' }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script id="machine-type-map-data" type="application/json">{{ machine_type_map | tojson }}</script>
<script>
const tbody = document.getElementById('tbody');
const selType  = document.getElementById('filterType');
const selBrand = document.getElementById('filterBrand');
const selLine  = document.getElementById('filterLine');
const startInp = document.getElementById('filterStart');
const endInp   = document.getElementById('filterEnd');
const btnExport = document.getElementById('exportBtn');

let machineTypeMap = {};
try { machineTypeMap = JSON.parse(document.getElementById('machine-type-map-data').textContent || '{}'); }
catch (_) { machineTypeMap = {}; }

function uniqueSorted(values){
  return [...new Set((values || []).filter(Boolean))].sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:'base', numeric:true }));
}

function ensureOption(select, value, label){
  if(!value) return;
  const exists = Array.from(select.options).some(o => o.value === value);
  if(exists) return;
  const o = document.createElement('option');
  o.value = value;
  o.textContent = label || value;
  select.appendChild(o);
}

function getBrandsForType(machineType){
  return uniqueSorted(machineTypeMap[machineType] || []);
}

function getAllBrands(){
  const all = [];
  Object.keys(machineTypeMap || {}).forEach(type => {
    all.push(...(machineTypeMap[type] || []));
  });
  return uniqueSorted(all);
}

function populateBrandOptions(){
  const selected = (selBrand.getAttribute('data-selected') || selBrand.value || '').trim();
  const machineType = (selType.value || '').trim();
  const brands = machineType ? getBrandsForType(machineType) : getAllBrands();

  selBrand.innerHTML = '<option value="">All</option>';
  brands.forEach(v => ensureOption(selBrand, v, v));

  if(selected){
    ensureOption(selBrand, selected, selected);
    selBrand.value = selected;
  }else{
    selBrand.value = '';
  }
}

selType.addEventListener('change', ()=>{
  selBrand.setAttribute('data-selected', '');
  populateBrandOptions();
});

document.getElementById('btnClear').addEventListener('click', ()=>{
  window.location.href = '/history';
});

function buildHistoryParams(){
  const params = new URLSearchParams();
  const line = (selLine.value || '').trim();
  const machineType = (selType.value || '').trim();
  const machineBrand = (selBrand.value || '').trim();
  const startDate = (startInp.value || '').trim();
  const endDate = (endInp.value || '').trim();

  if(line) params.set('line_op', line);
  if(machineType) params.set('machine_type', machineType);
  if(machineBrand) params.set('machine_brand', machineBrand);
  if(startDate) params.set('start_date', startDate);
  if(endDate) params.set('end_date', endDate);
  return params;
}

btnExport.addEventListener('click', ()=>{
  const params = buildHistoryParams();
  window.location.href = `/export/excel?${params.toString()}`;
});

populateBrandOptions();

let selectedTr = null;
tbody.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  if(selectedTr === tr){
    tr.classList.toggle('row-selected');
    if(!tr.classList.contains('row-selected')) selectedTr = null;
    return;
  }
  if(selectedTr) selectedTr.classList.remove('row-selected');
  tr.classList.add('row-selected');
  selectedTr = tr;
});
</script>
<script>
function goBack(){
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "/";
  }
}
</script>
</body>
</html>
