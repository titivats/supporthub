<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>History — Done & Cancelled Tickets</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --line:#e7e7ee; --muted:#6B7280; --thead:#f0f2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Arial}
    .container{max-width:1400px;margin:26px auto;padding:0 16px}
    .title{font-size:24px;font-weight:700;margin-bottom:8px}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 14px}

    .btn, a.btn, button.btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border:1px solid var(--line);border-radius:10px;
      background:#fff;text-decoration:none;color:#111;cursor:pointer;
      font-size:14px;line-height:1.2;
    }
    .btn.primary{background:#2563eb;color:#fff;border-color:#1f5fe6}
    select,input{padding:8px;border:1px solid #d7d9e0;border-radius:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .table-wrap{overflow:auto;max-height:calc(100vh - 220px);border-top:1px solid var(--line);}
    table{border-collapse:collapse; width:max-content; min-width:1600px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;white-space:nowrap}
    th{background:var(--thead); position:sticky; top:0; z-index:1}

    .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .cancel{background:#fef2f2;border-color:#fecaca;color:#991B1B}
    .done{background:#ecfeff;border-color:#bae6fd;color:#075985}

    .wrap-text{max-width:260px;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;}

    tbody tr{cursor:pointer; transition: background-color .15s ease;}
    tbody tr:hover{background:#f3f6ff;}
    tbody tr.row-selected{background:#e0f2fe !important; box-shadow: inset 0 0 0 2px #bae6fd;}
    .id-btn{all:unset; cursor:pointer; color:#2563eb; font-weight:600;}
    .id-btn:hover{text-decoration:underline;}
  </style>
</head>
<body>
<div class="container">
  <div class="title">Done & Cancelled Tickets</div>

  <form id="filterForm" class="filters">
    <label>Line No.
      <select name="line_op" id="filterLine">
        <option value="">All</option>
        {% for lo in line_ops %}
          <option value="{{ lo }}" {% if line_op==lo %}selected{% endif %}>{{ lo }}</option>
        {% endfor %}
        <!-- ตัวเลือกเพิ่มเติม -->
        <option value="PACKING" {% if line_op=='PACKING' %}selected{% endif %}>PACKING</option>
        <option value="REWORK" {% if line_op=='REWORK' %}selected{% endif %}>REWORK</option>
        <option value="CLEANING" {% if line_op=='CLEANING' %}selected{% endif %}>CLEANING</option>
      </select>
    </label>

    <!-- Machine (ประเภท) -->
    <label>Machine
      <select id="filterType">
        <option value="">All</option>
        <option value="Rework Machine">Rework Machine</option>
        <!-- ✅ กลุ่มใหม่ -->
        <option value="Etc..">Etc..</option>
      </select>
    </label>

    <!-- Machine Type (รุ่น/ยี่ห้อ) -->
    <label>Machine Type
      <select id="filterBrand">
        <option value="">All</option>
        <!-- ตัวเลือกจะถูกเติมตาม Machine -->
      </select>
    </label>

    <label>Date
      <input type="date" name="start_date" id="filterStart" value="{{ start_date or '' }}">
    </label>
    <span>to</span>
    <label>
      <input type="date" name="end_date" id="filterEnd" value="{{ end_date or '' }}">
    </label>

    <button class="btn primary" type="submit">Filter</button>
    <button class="btn" type="button" id="btnClear">Clear</button>
    <button class="btn" type="button" onclick="goBack()">Back</button>

    <button class="btn" type="button" id="exportBtn">Export Excel</button>
  </form>

  {% macro hms(sec) -%}
    {%- set s = (sec or 0)|int -%}
    {%- set h = s // 3600 -%}
    {%- set m = (s % 3600) // 60 -%}
    {%- set ss = s % 60 -%}
    {{ '%02d:%02d:%02d'|format(h,m,ss) }}
  {%- endmacro %}

  <div class="card">
    <div class="table-wrap">
      <table id="historyTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Status</th>
            <th>Created (TH)</th>
            <th>Closed (TH)</th>
            <th>Request by</th>
            <th>Line No.</th>
            <th>Machine</th>
            <th>Machine Type</th>
            <th>Problem</th>
            <th class="wrap-text">Description</th>
            <th>Doing</th>
            <th>Hold</th>
            <th>Hold Reason</th>
            <th>Waiting Time</th>
            <th>Downtime</th>
            <th>Solution</th>
            <th>Cancel Reason</th>
            <th>Done By</th>
          </tr>
        </thead>
        <tbody id="tbody">
          {% for r in rows %}
          {% set raw = (r.equipment or '') %}
          {% set type = (raw.split('||')[0] if '||' in raw else (r.equipment_type or r.machine)) %}
          {% set brand = (raw.split('||')[1] if '||' in raw else raw) %}
          {# ถ้า brand คือ Other M/C or Tools แต่ไม่มี type ให้จัดเป็น Etc.. #}
          {% if '||' not in raw and (brand|lower == 'other m/c or tools') %}
            {% set type = 'Etc..' %}
          {% endif %}
          {% set sum_secs = ((r.closed_at - r.created_at).total_seconds() if r.closed_at and r.created_at else 0) | int %}
          {% set doing    = (r.doing_secs or 0) | int %}
          {% set hold     = (r.hold_secs  or 0) | int %}
          {% set wait_secs = (sum_secs - doing - hold) if sum_secs>0 else 0 %}
          <tr id="row-{{ r.id }}"
              data-type="{{ (type or '')|e }}"
              data-brand="{{ (brand or '')|e }}"
              data-line="{{ r.machine|e }}"
              data-created="{{ (r.created_at.isoformat() if r.created_at else '')|e }}"
              data-closed="{{ (r.closed_at.isoformat() if r.closed_at else '')|e }}">
            <td><button class="id-btn" type="button" data-id="{{ r.id }}">{{ r.id }}</button></td>
            <td>
              {% if r.status == 'CANCELLED' %}
                <span class="badge cancel">CANCELLED</span>
              {% else %}
                <span class="badge done">DONE</span>
              {% endif %}
            </td>
            <td>{{ fmt_th(r.created_at) }}</td>
            <td>{{ fmt_th(r.closed_at) }}</td>
            <td>{{ r.requester }}</td>
            <td>{{ r.machine }}</td>
            <td>{{ (type or '') }}</td>
            <td>{{ brand }}</td>
            <td>{{ r.problem or '' }}</td>
            <td class="wrap-text">{{ r.description or '-' }}</td>
            <td>{{ hms(doing) }}</td>
            <td>{{ hms(hold) }}</td>
            <td class="wrap-text">{{ r.hold_reason or '-' }}</td>
            <td>{{ hms(wait_secs) }}</td>
            <td>{{ hms(sum_secs) }}</td>
            <td class="wrap-text">{{ r.solution or '-' }}</td>
            <td class="wrap-text">{{ r.cancel_reason or '-' }}</td>
            <td>
              {% if r.status == 'DONE' %}{{ r.done_by or '' }}
              {% elif r.status == 'CANCELLED' %}{{ r.canceled_by or '' }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ====== element refs ====== */
const tbody = document.getElementById('tbody');
const selType  = document.getElementById('filterType');
const selBrand = document.getElementById('filterBrand');
const selLine  = document.getElementById('filterLine');
const startInp = document.getElementById('filterStart');
const endInp   = document.getElementById('filterEnd');
const btnExport = document.getElementById('exportBtn');

const REWORK_TYPES = ['SRT Machine','Minipot','Oven'];
const ETC_TYPES    = ['Other M/C or Tools']; // สำหรับกลุ่ม Etc..
const EXCLUDED_MACHINE_TYPES = ['BT01','BT02','BT03','REWORK']; // ตัดออกจาก dropdown Machine

/* ====== Utilities ====== */
function uniqueValuesFromAttr(attr, filterType=null){
  const set = new Set();
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(filterType && tr.getAttribute('data-type') !== filterType) return;
    const val = tr.getAttribute(attr) || '';
    if(val) set.add(val);
  });
  return [...set].sort((a,b)=>a.localeCompare(b));
}
function ensureOption(select, value, label){
  const exists = [...select.options].some(o=>o.value===value);
  if(!exists){
    const o = document.createElement('option');
    o.value = value; o.textContent = label || value;
    select.appendChild(o);
  }
}

/* ====== Build options ====== */
function populateTypeOptions(){
  selType.innerHTML = '<option value="">All</option>';
  // ให้มีตัวเลือกเหล่านี้แน่นอน
  ensureOption(selType, 'Rework Machine', 'Rework Machine');
  ensureOption(selType, 'Etc..', 'Etc..');
  // เติมชนิดอื่น ๆ จากข้อมูล (ตัด BT01/BT02/BT03/REWORK)
  uniqueValuesFromAttr('data-type').forEach(v=>{
    if(!v) return;
    if(EXCLUDED_MACHINE_TYPES.includes(v.toUpperCase())) return;
    ensureOption(selType, v, v);
  });
}
function populateBrandOptions(){
  const t = selType.value || '';
  selBrand.innerHTML = '<option value="">All</option>';

  if(t === 'Rework Machine'){
    REWORK_TYPES.forEach(v=> ensureOption(selBrand, v, v));
    return;
  }
  if(t === 'Etc..'){
    ETC_TYPES.forEach(v=> ensureOption(selBrand, v, v));
    return;
  }

  // กรณี All หรือ Machine อื่น ๆ → ดึงยี่ห้อจากข้อมูล
  // และตัดชุดพิเศษของ Rework/Etc.. ออก
  const brands = uniqueValuesFromAttr('data-brand', t || null);
  brands.forEach(v=>{
    if(REWORK_TYPES.includes(v)) return;
    if(ETC_TYPES.includes(v)) return;
    ensureOption(selBrand, v, v);
  });
}

selType.addEventListener('change', ()=>{ selBrand.value=''; populateBrandOptions(); });

/* ====== กรองข้อมูล ====== */
function applyFilters(){
  const fType  = selType.value;
  const fBrand = selBrand.value;
  const fLine  = selLine.value;
  const fStart = startInp.value ? new Date(startInp.value+"T00:00:00") : null;
  const fEnd   = endInp.value   ? new Date(endInp.value+"T23:59:59") : null;

  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const t  = tr.getAttribute('data-type') || '';
    const b  = tr.getAttribute('data-brand') || '';
    const ln = tr.getAttribute('data-line') || '';
    const cr = tr.getAttribute('data-created') || '';
    const cl = tr.getAttribute('data-closed') || '';

    let ok = true;
    if(fType && t !== fType) ok = false;
    if(ok && fBrand && b !== fBrand) ok = false;
    if(ok && fLine && ln !== fLine) ok = false;

    if(ok && (fStart || fEnd)){
      const created = cr ? new Date(cr) : null;
      const closed  = cl ? new Date(cl) : null;
      const inRange = (dt)=>{
        if(!dt) return true;
        if(fStart && dt < fStart) return false;
        if(fEnd   && dt > fEnd)   return false;
        return true;
      };
      if(!(inRange(created) || inRange(closed))) ok = false;
    }

    tr.style.display = ok ? '' : 'none';
  });
}

/* Intercept ฟอร์มให้กรองในหน้า */
document.getElementById('filterForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  applyFilters();
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  selType.value='';
  selBrand.value='';
  selLine.value='';
  startInp.value='';
  endInp.value='';
  populateBrandOptions();
  applyFilters();
});

/* ====== เลือกแถว (ไฮไลท์) ====== */
let selectedTr = null;
tbody.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  if(selectedTr === tr){
    tr.classList.toggle('row-selected');
    if(!tr.classList.contains('row-selected')) selectedTr=null;
    return;
  }
  if(selectedTr) selectedTr.classList.remove('row-selected');
  tr.classList.add('row-selected');
  selectedTr = tr;
});

/* ====== Export (เรียกเซิร์ฟเวอร์สร้าง .xlsx จริง) ====== */
function buildExportURL(){
  const params = new URLSearchParams();
  const line  = selLine.value || "";
  const type  = selType.value || "";
  const brand = selBrand.value || "";
  const sd    = startInp.value || "";
  const ed    = endInp.value || "";

  if(line) params.set("line_op", line);
  // ส่ง equipment เฉพาะกรณีที่ระบุได้แน่ชัด
  if(type && brand){
    params.set("equipment", `${type}||${brand}`);
  } else if(!type && brand){
    // บางเรคคอร์ดเก่าเก็บแค่ brand เดี่ยว ๆ
    params.set("equipment", brand);
  }
  if(sd) params.set("start_date", sd);
  if(ed) params.set("end_date", ed);

  return `/export/excel?${params.toString()}`;
}
btnExport.addEventListener('click', ()=>{
  // ใช้ GET ไปยัง /export/excel จะได้ไฟล์ .xlsx จริง — ไม่มี popup เตือนอีก
  window.location.href = buildExportURL();
});

/* ====== INIT ====== */
populateTypeOptions();
populateBrandOptions();
applyFilters();
</script>
<script>
function goBack(){
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "/";
  }
}
</script>
</body>
</html>
